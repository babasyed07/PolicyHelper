#!/usr/bin/env python3\n\"\"\"\nComprehensive test suite for enhanced Policy Helper features\n\"\"\"\n\nimport unittest\nimport json\nimport os\nfrom policy_validator import PolicyValidator\nfrom policy_recommender import PolicyRecommender\nfrom approval_manager import ApprovalManager\nfrom chat_session import ChatSession, ChatManager\nfrom policy_generator import PolicyGenerator\n\nclass TestPolicyValidator(unittest.TestCase):\n    def setUp(self):\n        self.validator = PolicyValidator()\n        self.schema_context = {\n            'entities': ['User', 'Account', 'Transaction'],\n            'actions': ['CreateTransaction', 'ViewAccount', 'ModifyAccount']\n        }\n    \n    def test_valid_policy_syntax(self):\n        policy = 'forbid (principal == User::\"AccountHolder\", action == Action::\"CreateTransaction\", resource) when { resource.amount >= 5000 };'\n        is_valid, errors = self.validator.validate_policy(policy, self.schema_context)\n        self.assertTrue(is_valid, f\"Policy should be valid, but got errors: {errors}\")\n    \n    def test_invalid_syntax_missing_semicolon(self):\n        policy = 'forbid (principal == User::\"AccountHolder\", action == Action::\"CreateTransaction\", resource)'\n        is_valid, errors = self.validator.validate_policy(policy, self.schema_context)\n        self.assertFalse(is_valid)\n        self.assertIn(\"semicolon\", str(errors).lower())\n    \n    def test_schema_compliance(self):\n        policy = 'forbid (principal == InvalidEntity::\"Test\", action == Action::\"CreateTransaction\", resource);'\n        is_valid, errors = self.validator.validate_policy(policy, self.schema_context)\n        self.assertFalse(is_valid)\n        self.assertIn(\"Unknown entity type\", str(errors))\n    \n    def test_generate_test_cases(self):\n        policy = 'forbid (principal, action, resource) when { resource.amount >= 5000 };'\n        test_cases = self.validator.generate_test_cases(policy)\n        self.assertGreater(len(test_cases), 0)\n        self.assertIn('amount', str(test_cases))\n\nclass TestPolicyRecommender(unittest.TestCase):\n    def setUp(self):\n        self.schema_context = {\n            'entities': ['User', 'Account', 'Transaction'],\n            'actions': ['CreateTransaction', 'ViewAccount', 'ModifyAccount']\n        }\n        self.recommender = PolicyRecommender(self.schema_context)\n    \n    def test_generate_recommendations(self):\n        recommendations = self.recommender.generate_recommendations()\n        self.assertGreater(len(recommendations), 0)\n        \n        # Check for high-value transaction recommendation\n        high_value_rec = next((r for r in recommendations if r['id'] == 'high_value_tx'), None)\n        self.assertIsNotNone(high_value_rec)\n        self.assertEqual(high_value_rec['priority'], 'HIGH')\n    \n    def test_customize_recommendation(self):\n        customized = self.recommender.customize_recommendation('high_value_tx', {'threshold': 10000})\n        self.assertIsNotNone(customized)\n        self.assertIn('10000', customized)\n\nclass TestApprovalManager(unittest.TestCase):\n    def setUp(self):\n        self.approval_file = 'test_approvals.json'\n        self.approval_manager = ApprovalManager(self.approval_file)\n        # Clean up any existing test file\n        if os.path.exists(self.approval_file):\n            os.remove(self.approval_file)\n        self.approval_manager = ApprovalManager(self.approval_file)\n    \n    def tearDown(self):\n        if os.path.exists(self.approval_file):\n            os.remove(self.approval_file)\n    \n    def test_approve_policy(self):\n        policy_data = {\n            'requirement': 'Test requirement',\n            'policy': 'permit (principal, action, resource);',\n            'rationale': ['Test rationale']\n        }\n        \n        approval_id = self.approval_manager.approve_policy(policy_data, 'Good policy')\n        self.assertIsInstance(approval_id, int)\n        \n        stats = self.approval_manager.get_approval_stats()\n        self.assertEqual(stats['approved'], 1)\n        self.assertEqual(stats['total_policies'], 1)\n    \n    def test_reject_policy(self):\n        policy_data = {\n            'requirement': 'Test requirement',\n            'policy': 'invalid policy',\n            'rationale': ['Test rationale']\n        }\n        \n        rejection_id = self.approval_manager.reject_policy(policy_data, 'Syntax error')\n        self.assertIsInstance(rejection_id, int)\n        \n        stats = self.approval_manager.get_approval_stats()\n        self.assertEqual(stats['rejected'], 1)\n        self.assertEqual(stats['approval_rate'], 0)\n\nclass TestChatSession(unittest.TestCase):\n    def test_chat_session_creation(self):\n        session = ChatSession()\n        self.assertIsNotNone(session.session_id)\n        self.assertEqual(len(session.messages), 0)\n    \n    def test_add_message(self):\n        session = ChatSession()\n        session.add_message('user', 'Hello')\n        \n        self.assertEqual(len(session.messages), 1)\n        self.assertEqual(session.messages[0]['role'], 'user')\n        self.assertEqual(session.messages[0]['content'], 'Hello')\n    \n    def test_conversation_context(self):\n        session = ChatSession()\n        session.add_message('user', 'Create a policy')\n        session.add_message('assistant', 'Here is your policy')\n        \n        context = session.get_conversation_context()\n        self.assertIn('Human: Create a policy', context)\n        self.assertIn('Assistant: Here is your policy', context)\n\nclass TestChatManager(unittest.TestCase):\n    def test_create_and_get_session(self):\n        manager = ChatManager()\n        session_id = manager.create_session()\n        \n        self.assertIsNotNone(session_id)\n        \n        session = manager.get_session(session_id)\n        self.assertIsNotNone(session)\n        self.assertEqual(session.session_id, session_id)\n    \n    def test_cleanup_old_sessions(self):\n        manager = ChatManager()\n        session_id = manager.create_session()\n        \n        # Simulate old session by modifying timestamp\n        session = manager.get_session(session_id)\n        session.last_activity = session.last_activity.replace(year=2020)\n        \n        cleaned = manager.cleanup_old_sessions(1)  # 1 hour max age\n        self.assertEqual(cleaned, 1)\n        self.assertIsNone(manager.get_session(session_id))\n\nclass TestIntegration(unittest.TestCase):\n    \"\"\"Integration tests for the complete workflow\"\"\"\n    \n    def setUp(self):\n        # Clean up test files\n        test_files = ['test_policy_history.json', 'test_policy_approvals.json']\n        for file in test_files:\n            if os.path.exists(file):\n                os.remove(file)\n    \n    def test_complete_policy_workflow(self):\n        \"\"\"Test the complete workflow from generation to approval\"\"\"\n        # This test requires a mock or offline mode since it would call Bedrock\n        # For now, we'll test the components individually\n        \n        # Test schema loading\n        if os.path.exists('sample_banking_schema.json'):\n            generator = PolicyGenerator('sample_banking_schema.json')\n            recommendations = generator.get_recommendations()\n            self.assertGreater(len(recommendations), 0)\n        \n        # Test approval workflow\n        approval_manager = ApprovalManager('test_policy_approvals.json')\n        policy_data = {\n            'requirement': 'Integration test',\n            'policy': 'permit (principal, action, resource);',\n            'rationale': ['Integration test rationale'],\n            'validation': {'is_valid': True, 'errors': []}\n        }\n        \n        approval_id = approval_manager.approve_policy(policy_data)\n        self.assertIsInstance(approval_id, int)\n        \n        stats = approval_manager.get_approval_stats()\n        self.assertEqual(stats['total_policies'], 1)\n        self.assertEqual(stats['approval_rate'], 100.0)\n\ndef run_offline_tests():\n    \"\"\"Run tests that don't require AWS connectivity\"\"\"\n    print(\"\\nðŸ§ª Running Enhanced Policy Helper Tests\")\n    print(\"=\"*50)\n    \n    # Create test suite\n    suite = unittest.TestSuite()\n    \n    # Add test classes\n    test_classes = [\n        TestPolicyValidator,\n        TestPolicyRecommender,\n        TestApprovalManager,\n        TestChatSession,\n        TestChatManager,\n        TestIntegration\n    ]\n    \n    for test_class in test_classes:\n        tests = unittest.TestLoader().loadTestsFromTestCase(test_class)\n        suite.addTests(tests)\n    \n    # Run tests\n    runner = unittest.TextTestRunner(verbosity=2)\n    result = runner.run(suite)\n    \n    # Print summary\n    print(\"\\n\" + \"=\"*50)\n    print(f\"Tests run: {result.testsRun}\")\n    print(f\"Failures: {len(result.failures)}\")\n    print(f\"Errors: {len(result.errors)}\")\n    \n    if result.failures:\n        print(\"\\nFailures:\")\n        for test, traceback in result.failures:\n            print(f\"- {test}: {traceback}\")\n    \n    if result.errors:\n        print(\"\\nErrors:\")\n        for test, traceback in result.errors:\n            print(f\"- {test}: {traceback}\")\n    \n    success_rate = ((result.testsRun - len(result.failures) - len(result.errors)) / result.testsRun * 100) if result.testsRun > 0 else 0\n    print(f\"\\nâœ… Success Rate: {success_rate:.1f}%\")\n    \n    return result.wasSuccessful()\n\nif __name__ == '__main__':\n    success = run_offline_tests()\n    exit(0 if success else 1)